# Progress - Sistema de Gestión Logística

## Iteration 1 (2026-01-10)

### Completed Features

#### Story 6.1: Carga de Archivos CSV para Importación de Pedidos
- **Implemented**: POST /api/orders/import endpoint
- **Features**:
  - Accepts CSV files as base64 encoded content
  - Automatic delimiter detection (comma or semicolon)
  - UTF-8 encoding support
  - CSV parsing with quoted value handling
  - Preview mode (validation only) and process mode
  - Required field validation (tracking_id, address, latitude, longitude)
  - Duplicate tracking ID detection (within CSV and against database)
  - Coordinate validation (range checks and (0,0) warning)
  - Time window preset validation
  - Column mapping support with default English/Spanish headers
  - Batch import with progress reporting
  - Detailed error reporting with row numbers
- **Status**: ✅ Passes all requirements

#### Story 6.2: Validación de Datos Durante Importación
- **Implemented**: Enhanced validation with error categorization
- **Features**:
  - Error severity levels: critical, warning, info
  - Error type categorization: required_field, format, range, duplicate, reference, validation
  - Valid/invalid record separation in response
  - Error summary statistics (by field, severity, error type)
  - Required field errors reported as critical with specific messages
  - Coordinate validation (range checks with specific error messages)
  - (0, 0) coordinate detection as warning (not blocking)
  - Duplicate tracking ID detection (within CSV and database)
  - Email format validation as warning
  - Numeric field validation (weight, volume must be positive)
  - Strictness validation (HARD or SOFT only)
  - Time window preset reference validation
  - Complete validation BEFORE any database modification
  - Enhanced API response with validRecords and invalidRecords arrays
- **API Response Structure**:
  ```typescript
  {
    success, totalRows, validRows, invalidRows, importedRows,
    errors: CSVValidationError[],
    validRecords: CSVRecordValidationResult[],
    invalidRecords: CSVRecordValidationResult[],
    preview, duplicateTrackingIds,
    summary: { byField, bySeverity, byErrorType }
  }
  ```
- **Status**: ✅ Passes all requirements

#### Story 6.3: Mapeo de Columnas del CSV
- **Implemented**: Enhanced column mapping system with templates and similarity algorithm
- **Features**:
  - Database table `csv_column_mapping_templates` for storing reusable mappings
  - Column mapping template CRUD API endpoints:
    - GET /api/csv-column-mapping-templates - List all templates
    - POST /api/csv-column-mapping-templates - Create new template
    - GET /api/csv-column-mapping-templates/[id] - Get specific template
    - PATCH /api/csv-column-mapping-templates/[id] - Update template
    - DELETE /api/csv-column-mapping-templates/[id] - Soft delete template
  - Column mapping suggestion endpoint:
    - POST /api/orders/import/suggest-mapping - Get AI-powered column suggestions
  - Fuzzy matching algorithm using Levenshtein distance for similarity scoring
  - Auto-completion of mapping based on column name similarity (multi-language support)
  - Extended default mapping with English and Spanish variations
  - Template-based import support (can specify templateId instead of columnMapping)
  - Validation helpers for required fields mapping
  - Updated import endpoint to support:
    - templateId parameter for using saved templates
    - Auto-mapping fallback when no mapping provided
    - Returns column mapping info in response
- **API Response for Suggestions**:
  ```typescript
  {
    suggestedMapping: Record<string, CSV_SYSTEM_FIELD>,
    confidence: Record<string, number>, // 0-1 score per mapping
    unmappedRequiredFields: string[],
    unmappedOptionalFields: string[],
    autoMappedCount: number,
    manualMappingRequired: boolean,
    requiredFieldsValidation: { valid: boolean, missingFields: string[] }
  }
  ```
- **Files Added**:
  - src/lib/validations/csv-column-mapping.ts - Validation schemas
  - src/lib/csv-column-mapping.ts - Similarity algorithm and utilities
  - src/app/api/csv-column-mapping-templates/route.ts - Template CRUD
  - src/app/api/csv-column-mapping-templates/[id]/route.ts - Single template operations
  - src/app/api/orders/import/suggest-mapping/route.ts - Mapping suggestions
- **Files Modified**:
  - src/db/schema.ts - Added csvColumnMappingTemplates table
  - src/app/api/orders/import/route.ts - Added template support and auto-mapping
- **Status**: ✅ Passes all requirements

#### Story 6.4: Geocodificación y Priorización de Coordenadas
- **Implemented**: GeoJSON API endpoint and interactive map visualization
- **Features**:
  - GET /api/orders/geojson endpoint returning GeoJSON FeatureCollection
  - Direct use of coordinates from CSV when valid
  - Color-coded markers by order status (PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, FAILED, CANCELLED)
  - Interactive tooltips showing tracking ID, customer name, address, and status
  - Automatic clustering for many nearby points using maplibre-gl built-in clustering
  - Click on cluster zooms to separate individual points
  - Bounding box filtering for performance with large datasets
  - Debounced map movement events to avoid excessive API calls
  - Auto-fit bounds on initial load to show all orders
  - Order count display showing number of visible orders
  - Search and status filtering support
  - Tenant-aware with multi-tenancy support
- **API Response Structure**:
  ```typescript
  {
    type: "FeatureCollection",
    features: [{
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [longitude, latitude]
      },
      properties: {
        id: string,
        trackingId: string,
        customerName: string,
        address: string,
        status: ORDER_STATUS,
        color: string
      }
    }],
    metadata: {
      total: number,
      limit: number,
      filtered?: string,
      bbox?: string
    }
  }
  ```
- **Files Added**:
  - src/app/api/orders/geojson/route.ts - GeoJSON endpoint
  - src/components/orders/order-map.tsx - Map component with clustering
- **Files Modified**:
  - src/app/orders/page.tsx - Added list/map view toggle
- **Status**: ✅ Passes all requirements

