# Progress - Sistema de Gestión Logística

## 2025-01-10 - Story 7.1: Configuración del Depot y Recursos Base

### Completed

**Database Schema:**
- Added `optimizationConfigurations` table to `src/db/schema.ts`
- Added `OPTIMIZATION_OBJECTIVE` constant (DISTANCE, TIME, BALANCED)
- Configuration includes depot location, vehicle/driver selection, optimization parameters

**Validation:**
- Created `src/lib/validations/optimization-config.ts`
- Coordinate validation (latitude: -90 to 90, longitude: -180 to 180)
- Rejection of (0, 0) coordinates
- Time format validation (HH:MM)
- UUID array validation for vehicles and drivers

**API Routes:**
- Created `src/app/api/optimization/configure/route.ts` (GET, POST)
  - GET: List configurations with filtering
  - POST: Create configuration with validation
  - Validates all vehicles exist and are AVAILABLE
  - Validates all drivers exist and are AVAILABLE
  - Checks for expired driver licenses
- Created `src/app/api/optimization/configure/[id]/route.ts` (GET, PATCH, DELETE)
  - GET: Fetch single configuration
  - PATCH: Update configuration (blocked during OPTIMIZING status)
  - DELETE: Delete configuration (blocked during OPTIMIZING status)

**UI Components:**
- Created `src/components/ui/select.tsx` - Radix UI select component
- Created `src/components/ui/checkbox.tsx` - Radix UI checkbox component
- Created `src/components/ui/card.tsx` - Card layout component

**Optimization Components:**
- Created `src/components/optimization/depot-selector.tsx`
  - Interactive MapLibre GL map with click-to-select
  - Manual input mode for coordinates
  - "Use My Location" geolocation feature
  - Depot marker visualization
  - Address field support

- Created `src/components/optimization/vehicle-selector.tsx`
  - Multi-select vehicle cards
  - Filter by fleet, type, search
  - Shows vehicle: plate, type, capacities, fleet, status
  - Only AVAILABLE vehicles shown
  - Select all filtered functionality
  - Visual feedback for selected items

- Created `src/components/optimization/driver-selector.tsx`
  - Multi-select driver cards
  - Filter by fleet, license status, search
  - Shows driver: name, ID, license number, expiry, fleet
  - License status indicators (valid, expiring soon, expired)
  - Expired licenses are grayed out and disabled
  - Auto-filters out drivers with expired licenses

**Page:**
- Created `src/app/optimization/page.tsx`
  - Two-step wizard: Resources → Settings
  - Step 1: Depot selection, vehicle selection, driver selection
  - Step 2: Configuration name, optimization strategy, capacity constraints, time settings
  - Summary before creation
  - Full validation before allowing proceed

### Steps Verified (from PRD 7.1)
- [x] Depot selector allows location by click on map or direct input
- [x] System validates depot coordinates before optimization
- [x] Vehicle list shows: plate, type, capacities, and fleet
- [x] Vehicle selection allows filtering by type, fleet, and status
- [x] Driver list shows: name, fleet, and license information
- [x] Driver selection filters out expired/restricted licenses
- [x] API receives configuration as part of optimization request

